name: Build Mobile APK
on:
  push:
    branches: [ master ]
    paths:
      - 'mep-mobile/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Grant execute permission for gradlew
        run: chmod +x mep-mobile/gradlew
      
      - name: Build APK
        run: |
          cd mep-mobile
          ./gradlew assembleRelease --no-daemon
      
      - name: Sign APK
        run: |
          cd mep-mobile
          # For now, using debug keystore. Replace with release keystore later.
          ./gradlew assembleDebug --no-daemon
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: MEPApp-Build-${{ github.run_number }}
          path: mep-mobile/app/build/outputs/apk/debug/app-debug.apk
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/master'
        with:
          tag_name: mobile-v1.0.${{ github.run_number }}
          name: MEP Mobile App v1.0.${{ github.run_number }}
          files: mep-mobile/app/build/outputs/apk/debug/app-debug.apk
          body: |
            ## MEP Mobile App - Latest Build
            
            ### What's New:
            - ✅ Reliable call log sync (WorkManager)
            - ✅ 240-day historical sync (includes August 2025)
            - ✅ Improved permission dialogs
            - ✅ Automatic sync without opening app
            
            ### Installation:
            1. Download the APK below
            2. Install on your device
            3. Grant all permissions when prompted
            
            **Important:** Clear app data after installing to force fresh historical sync.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
